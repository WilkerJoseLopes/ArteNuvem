{% extends "base.html" %}
{% block content %}
<h1>Painel de Administração</h1>

<!-- MENSAGENS -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div style="margin-bottom:1rem;">
    {% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<section class="admin-section" style="display:grid; grid-template-columns: 1fr 380px; gap:1.2rem; align-items:start;">

  <!-- COLUNA ESQUERDA: Criar Exposição + Exposições existentes -->
  <div>

    <section class="card" style="padding:1rem; margin-bottom:1rem;">
      <h2 style="margin-top:0;">Criar nova exposição</h2>
      <form method="post" class="form">
        <input type="hidden" name="action" value="create_exposicao">

        <label>Nome da Exposição</label>
        <input type="text" name="nome" placeholder="Ex: Exposição de Maio" required>

        <label>Descrição (opcional)</label>
        <textarea name="descricao" placeholder="Descrição breve"></textarea>

        <label>Escolher Categoria (opcional)</label>
        <select name="categoria_id">
          <option value="">(Sem categoria)</option>
          {% for c in categorias %}
            <option value="{{ c.id }}">{{ c.nome }}</option>
          {% endfor %}
        </select>

        <label>Filtro por tags (opcional, separadas por vírgula)</label>
        <input type="text" name="tags_filtro" placeholder="tag1, tag2">

        <div style="margin-top:0.5rem;">
          <label><input type="checkbox" name="usar_tags" value="1"> Usar filtro de tags</label>
          <label style="margin-left:0.8rem;"><input type="checkbox" name="usar_categorias" value="1" checked> Filtrar por categoria</label>
        </div>

        <hr style="margin:0.8rem 0;">

        <label>Definição de datas</label>
        <div>
          <label><input type="radio" name="tipo_periodo" value="mes_inteiro" checked> Mês inteiro</label>
          <label style="margin-left:0.8rem;"><input type="radio" name="tipo_periodo" value="intervalo"> Dias específicos</label>
        </div>

        <div id="mes-inputs" style="margin-top:0.6rem;">
          <label>Mês e ano</label>
          <select name="mes" required>
            {% for m in range(1,13) %}
              <option value="{{ '{:02d}'.format(m) }}">{{ '{:02d}'.format(m) }}</option>
            {% endfor %}
          </select>
          <select name="ano" required>
            {% for y in range(2024, 2031) %}
              <option value="{{ y }}">{{ y }}</option>
            {% endfor %}
          </select>
        </div>

        <div id="intervalo-inputs" style="display:none; margin-top:0.6rem;">
          <label>Data início</label>
          <input type="date" name="start_date">
          <label>Data fim</label>
          <input type="date" name="end_date">
        </div>

        <div style="margin-top:0.8rem;">
          <button type="submit" class="btn">Criar Exposição</button>
        </div>
      </form>
    </section>

    <section class="card" style="padding:1rem;">
      <h2 style="margin-top:0;">Exposições existentes</h2>

      {% for e in exposicoes %}
      <div class="card" style="margin-bottom: 1rem; padding: 0.8rem;">
        <form method="post" class="form">
          <input type="hidden" name="action" value="update_exposicao">
          <input type="hidden" name="exposicao_id" value="{{ e.id }}">

          <label>Nome</label>
          <input type="text" name="nome" value="{{ e.nome }}">

          <label>Descrição</label>
          <input type="text" name="descricao" value="{{ e.descricao or '' }}">

          <label>Ativo</label>
          <select name="ativo">
            <option value="1" {% if e.ativo %}selected{% endif %}>Sim</option>
            <option value="0" {% if not e.ativo %}selected{% endif %}>Não</option>
          </select>

          <label>Categoria</label>
          <select name="categoria_id">
            <option value="">(Sem categoria)</option>
            {% for c in categorias %}
              <option value="{{ c.id }}" {% if e.categoria_id == c.id %}selected{% endif %}>{{ c.nome }}</option>
            {% endfor %}
          </select>

          <label>Tags filtro</label>
          <input type="text" name="tags_filtro" value="{{ e.tags_filtro or '' }}">

          <div style="margin-top:0.6rem;">
            <label>Período:</label>
            <div>
              {% if e.mes_inteiro %}
                <em>Mês inteiro ({{ e.mes or '—' }})</em>
              {% else %}
                <em>
                  {% if e.start_date %}{{ e.start_date.strftime("%d/%m/%Y") }}{% else %}(?){% endif %}
                  →
                  {% if e.end_date %}{{ e.end_date.strftime("%d/%m/%Y") }}{% else %}(?){% endif %}
                </em>
              {% endif %}
            </div>
          </div>

          <div style="margin-top:0.6rem; display:flex; gap:0.5rem;">
            <button type="submit" class="btn">Guardar alterações</button>

            <form method="post" style="margin:0;">
              <input type="hidden" name="action" value="delete_exposicao">
              <input type="hidden" name="exposicao_id" value="{{ e.id }}">
              <button type="submit" class="btn-danger" onclick="return confirm('Apagar exposição?');">Apagar exposição</button>
            </form>
          </div>
        </form>

        <div style="margin-top:0.6rem;">
          <a href="{{ url_for('exportar_exposicao') }}?exposicao_id={{ e.id }}" class="btn-link">Exportar top10 (PDF)</a>
          <a href="{{ url_for('exposicao') }}?exposicao_id={{ e.id }}" class="btn-link" style="margin-left:0.6rem;">Ver exposição</a>
        </div>
      </div>
      {% else %}
        <p>Sem exposições registadas.</p>
      {% endfor %}
    </section>

  </div>

  <!-- COLUNA DIREITA: Gestão de Categorias -->
  <aside>
    <section class="card" style="padding:1rem; margin-bottom:1rem;">
      <h2 style="margin-top:0;">Categorias</h2>
      <form method="post" class="form" style="margin-bottom:0.6rem;">
        <input type="hidden" name="action" value="create_categoria">
        <label>Novo nome</label>
        <input type="text" name="nome" placeholder="Ex: Fotos" required>
        <div style="margin-top:0.5rem;">
          <button type="submit" class="btn">Criar categoria</button>
        </div>
      </form>

      <div style="margin-top:0.8rem;">
        {% for c in categorias %}
          <div style="display:flex; justify-content:space-between; align-items:center; padding:0.3rem 0; border-bottom:1px solid rgba(0,0,0,0.04);">
            <div style="font-weight:600;">{{ c.nome }}</div>
            <div style="display:flex; gap:0.4rem; align-items:center;">
              <form method="post" style="margin:0;">
                <input type="hidden" name="action" value="delete_categoria">
                <input type="hidden" name="categoria_id" value="{{ c.id }}">
                <button type="submit" class="btn-sm" onclick="return confirm('Apagar categoria? Imagens ficarão sem categoria.');">Apagar</button>
              </form>
            </div>
          </div>
        {% else %}
          <p class="small">Não há categorias.</p>
        {% endfor %}
      </div>
    </section>

    <section class="card" style="padding:1rem;">
      <h2 style="margin-top:0;">Utilizadores</h2>
      <p class="small">Lista rápida de utilizadores (apenas para referência)</p>
      <div style="max-height:260px; overflow:auto; margin-top:0.5rem;">
        {% for u in usuarios if usuarios is defined %}
          <div style="display:flex; gap:0.5rem; align-items:center; padding:0.3rem 0; border-bottom:1px solid rgba(0,0,0,0.04);">
            <img src="{{ u.foto_url or url_for('static', filename='img/avatar_default.png') }}" style="width:34px;height:34px;border-radius:50%; object-fit:cover;">
            <div>
              <div style="font-weight:600;">{{ u.nome or u.email }}</div>
              <div class="small">{{ u.email }}</div>
            </div>
          </div>
        {% else %}
          <p class="small">Sem utilizadores disponíveis.</p>
        {% endfor %}
      </div>
    </section>
  </aside>

</section>

<script>
document.querySelectorAll('input[name="tipo_periodo"]').forEach(r => {
  r.addEventListener('change', function(){
    const tipo = this.value;
    document.getElementById('mes-inputs').style.display = tipo === 'mes_inteiro' ? 'block' : 'none';
    document.getElementById('intervalo-inputs').style.display = tipo === 'intervalo' ? 'block' : 'none';
  });
});
</script>

<style>
.card { background:var(--card); border-radius:0.6rem; padding:0.8rem; box-shadow:var(--shadow); }
.form input[type="text"], .form textarea, .form select, .form input[type="date"] {
  width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:0.35rem; box-sizing:border-box; margin-bottom:0.5rem;
}
.btn { background:var(--primary); color:white; padding:0.5rem 0.8rem; border-radius:0.45rem; border:0; cursor:pointer; }
.btn-danger { background:#b91c1c; color:white; padding:0.45rem 0.7rem; border-radius:0.45rem; border:0; cursor:pointer; }
.btn-link { color:var(--primary); text-decoration:none; }
.btn-sm { background:transparent; border:1px solid var(--border); padding:0.25rem 0.45rem; border-radius:0.35rem; }
.alert { padding:0.5rem; border-radius:0.35rem; margin-bottom:0.3rem; }
.alert-success { background:#e6ffed; color:#0b6621; }
.alert-error { background:#ffe6e6; color:#8b0b0b; }
.small { font-size:0.9rem; color:var(--muted); }
</style>

{% endblock %}
