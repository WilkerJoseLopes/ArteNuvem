{% extends "base.html" %}
{% block content %}

<div class="imagem-detalhe grid" style="grid-template-columns: 1fr 360px; gap: 1.25rem; align-items:start;">

  <!-- IMAGEM PRINCIPAL -->
  <div class="imagem-box card" style="padding:0;">
    <img src="{{ imagem.caminho_armazenamento }}" alt="{{ imagem.titulo }}" style="width:100%; display:block; border-radius:0.5rem 0.5rem 0 0; object-fit:contain; max-height:75vh;">
    <div class="card-body">
      <h2 style="margin:0 0 0.5rem 0;">{{ imagem.titulo }}</h2>

      {% if imagem.tags %}
        <div style="margin-bottom:0.5rem;">
          {% for t in (imagem.tags.split(',') if imagem.tags else []) %}
            <span class="badge" style="margin-right:0.35rem;">{{ t.strip() }}</span>
          {% endfor %}
        </div>
      {% endif %}

      <p class="small">Publicado: {{ imagem.data_upload.strftime('%Y-%m-%d %H:%M') if imagem.data_upload else '' }}</p>

      <div style="margin-top:1rem;">
        <a class="btn-link" href="{{ url_for('index') }}">← Voltar</a>
      </div>
    </div>
  </div>

  <!-- SIDEBAR: AUTOR / AÇÕES / COMENTÁRIOS PREVIEW -->
  <aside>
    <!-- AUTOR -->
    <div class="card" style="padding:0.75rem; display:flex; gap:0.75rem; align-items:center;">
      <img src="{{ autor.foto_url if autor and autor.foto_url else url_for('static', filename='img/avatar_default.png') }}" class="user-avatar" style="width:48px;height:48px;border-radius:50%;">
      <div>
        <a href="{{ url_for('perfil', user_id=autor.id if autor else 0) }}" style="text-decoration:none; color:inherit;">
          <div style="font-weight:700;">{{ autor.nome if autor else 'Anónimo' }}</div>
        </a>
        <div class="small">ID: {{ autor.id if autor else '—' }}</div>
      </div>
    </div>

    <!-- CATEGORIA / AÇÕES -->
    <div class="card" style="margin-top:0.8rem; padding:0.75rem;">
      {% if imagem.categoria_texto %}
      <div style="margin-bottom:0.5rem;">Categoria: <strong>{{ imagem.categoria_texto }}</strong></div>
      {% endif %}

      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.6rem;">
        <button id="likeBtn" class="like-btn {% if user_liked %}liked{% endif %}" data-imagem-id="{{ imagem.id }}" aria-pressed="{{ 'true' if user_liked else 'false' }}">
          <span id="likeHeart">❤</span> <span id="likeCount">{{ likes }}</span>
        </button>

        {% if current_user and (current_user.id == imagem.id_utilizador or (current_user.email and current_user.email|lower in ADMIN_EMAILS)) %}
        <form action="{{ url_for('apagar_imagem', imagem_id=imagem.id) }}" method="post" style="margin:0;">
          <button type="submit" class="icon-btn" onclick="return confirm('Apagar esta imagem?');">Apagar</button>
        </form>
        {% endif %}
      </div>

      <div class="small">Link público: <a href="{{ imagem.caminho_armazenamento }}" target="_blank" style="color:inherit; text-decoration:underline;">Abrir imagem</a></div>
    </div>

    <!-- COMENTÁRIOS - PREVIEW -->
    <div class="card" style="margin-top:0.8rem; padding:0.75rem;">
      <h4 style="margin:0 0 0.5rem 0;">Comentários ({{ comentarios|length }})</h4>
      <div style="max-height:220px; overflow:auto;">
        {% if comentarios %}
          {% for c,u in comentarios[:6] %}
          <div style="display:flex; gap:0.6rem; align-items:flex-start; margin-bottom:0.5rem;">
            <img src="{{ u.foto_url if u and u.foto_url else url_for('static', filename='img/avatar_default.png') }}" class="avatar-sm" style="width:34px;height:34px;border-radius:50%;">
            <div style="flex:1;">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <a href="{{ url_for('perfil', user_id=u.id) }}"><strong>{{ u.nome }}</strong></a>
                  <div class="small" style="color:var(--muted); font-size:0.85rem;">{{ c.data.strftime('%Y-%m-%d %H:%M') if c.data else '' }}</div>
                </div>
                <div>
                  <button class="btn-link btn-reply" data-comentario-id="{{ c.id }}">Responder</button>
                </div>
              </div>
              <div class="small" style="margin-top:0.25rem;">{{ c.texto }}</div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <p class="small">Sem comentários ainda.</p>
        {% endif %}
      </div>
      <div style="margin-top:0.5rem;">
        <a href="#comments-full" class="btn-link">Ver todos / Comentar</a>
      </div>
    </div>

  </aside>
</div>

<hr style="margin:1.25rem 0;">

<!-- SEÇÃO COMPLETA DE COMENTÁRIOS -->
<div id="comments-full" class="comentarios">
  <h3>Comentários ({{ comentarios|length }})</h3>

  {% if current_user %}
  <form id="commentForm" action="{{ url_for('comentario') }}" method="post" class="form-comentario" style="margin-bottom:1rem;">
    <input type="hidden" name="imagem_id" value="{{ imagem.id }}">
    <input type="hidden" name="id_comentario_pai" id="id_comentario_pai" value="">
    <div style="display:flex; gap:0.6rem; align-items:flex-start;">
      <img src="{{ current_user.foto_url if current_user and current_user.foto_url else url_for('static', filename='img/avatar_default.png') }}" class="user-avatar" style="width:40px;height:40px;border-radius:50%;">
      <textarea name="texto" id="commentText" placeholder="Escreve um comentário." required maxlength="140" style="flex:1; padding:0.6rem; border-radius:0.5rem; border:1px solid var(--border);"></textarea>
    </div>
    <div style="margin-top:0.5rem; display:flex; gap:0.5rem;">
      <button type="submit" class="btn">Comentar</button>
      <button type="button" id="cancelReply" class="btn-outline" style="display:none;">Cancelar resposta</button>
    </div>
  </form>
  {% else %}
  <p>Faz login para comentar.</p>
  {% endif %}

  <div class="comentarios-lista">
    {% for c,u in comentarios %}
    <div class="comentario" style="display:flex; gap:0.8rem; align-items:flex-start; padding:0.6rem 0;">
      <img src="{{ u.foto_url if u and u.foto_url else url_for('static', filename='img/avatar_default.png') }}" class="avatar-sm" style="width:40px;height:40px;border-radius:50%;">
      <div style="flex:1;">
        <div style="display:flex; justify-content:space-between; gap:0.6rem; align-items:flex-start;">
          <div>
            <a href="{{ url_for('perfil', user_id=u.id) }}"><strong>{{ u.nome }}</strong></a>
            <div class="small" style="color:var(--muted);">{{ c.data.strftime('%Y-%m-%d %H:%M') if c.data else '' }}</div>
          </div>
          <div style="display:flex; gap:0.5rem; align-items:center;">
            {% if current_user and (current_user.id == c.id_utilizador or (current_user.email and current_user.email|lower in ADMIN_EMAILS)) %}
            <form action="{{ url_for('apagar_comentario', comentario_id=c.id) }}" method="post" style="margin:0;">
              <button type="submit" class="icon-btn" onclick="return confirm('Apagar comentário?');">Apagar</button>
            </form>
            {% endif %}
            <button class="btn-link btn-reply" data-comentario-id="{{ c.id }}">Responder</button>
          </div>
        </div>
        <div style="margin-top:0.35rem;">{{ c.texto }}</div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  // like toggle (AJAX -> fallback to form submit)
  document.addEventListener('click', function(e){
    const likeBtn = e.target.closest('#likeBtn');
    if(!likeBtn) return;
    e.preventDefault();
    const id = likeBtn.dataset.imagemId;
    // try AJAX
    fetch('{{ url_for("url_for", _external=False) }}'.replace('url_for', 'reacao/toggle'), {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({imagem_id: Number(id), tipo: 'like'})
    }).then(r=>r.json()).then(resp=>{
      if(resp && resp.likes !== undefined){
        document.getElementById('likeCount').textContent = resp.likes;
        if(resp.user_liked){
          likeBtn.classList.add('liked');
          likeBtn.setAttribute('aria-pressed','true');
        } else {
          likeBtn.classList.remove('liked');
          likeBtn.setAttribute('aria-pressed','false');
        }
      } else {
        // fallback: submit simple form
        submitLikeFallback(id);
      }
    }).catch(()=> submitLikeFallback(id));
  });

  function submitLikeFallback(id){
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/reacao';
    const tipo = document.createElement('input'); tipo.type='hidden'; tipo.name='tipo'; tipo.value='like';
    const imagem = document.createElement('input'); imagem.type='hidden'; imagem.name='imagem_id'; imagem.value = id;
    form.appendChild(tipo); form.appendChild(imagem);
    document.body.appendChild(form);
    form.submit();
  }

  // reply button behaviour
  document.querySelectorAll('.btn-reply').forEach(btn=>{
    btn.addEventListener('click', function(e){
      const id = this.dataset.comentarioId;
      const parentInput = document.getElementById('id_comentario_pai');
      if(!parentInput) return;
      parentInput.value = id;
      document.getElementById('commentText').focus();
      document.getElementById('cancelReply').style.display = 'inline-block';
    });
  });

  document.getElementById('cancelReply')?.addEventListener('click', function(){
    const parentInput = document.getElementById('id_comentario_pai');
    parentInput.value = '';
    this.style.display = 'none';
    document.getElementById('commentText').value = '';
  });

  // small UX: prevent double-submit on comment form
  const commentForm = document.getElementById('commentForm');
  if(commentForm){
    commentForm.addEventListener('submit', function(){
      const btn = this.querySelector('button[type="submit"]');
      if(btn) btn.disabled = true;
    });
  }
</script>

<style>
/* pequenas correções locais para consistência */
.like-btn { background:transparent; border:1px solid var(--border); padding:0.35rem 0.5rem; border-radius:6px; cursor:pointer; }
.like-btn.liked { background:var(--accent); color:#fff; border-color:var(--accent); }
.btn-link { background:none; border:none; color:var(--accent); cursor:pointer; text-decoration:underline; padding:0; }
.btn-outline { background:transparent; border:1px solid var(--border); padding:0.35rem 0.6rem; border-radius:6px; cursor:pointer; }
.icon-btn { background:transparent; border:1px solid var(--border); padding:0.25rem 0.5rem; border-radius:6px; cursor:pointer; }
</style>

{% endblock %}
